<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Website-Generator KI</title>
  <style>
    :root { --bg:#0b1022; --panel:#0f172a; --muted:#94a3b8; --border:rgba(148,163,184,.3); --accent:#3b82f6; --accent2:#1d4ed8; --text:#e5e7eb; }
    *{box-sizing:border-box}
    body{font-family:Arial, sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;min-height:100vh;margin:0;padding:30px}
    h1{margin:0 0 8px}
    p.hint{color:var(--muted);margin:0 0 8px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    input,button,textarea{border-radius:10px;font-size:14px;border:1px solid var(--border);background:var(--panel);color:var(--text)}
    textarea{width:90%;max-width:900px;height:140px;padding:12px;margin:8px 0}
    button{padding:10px;cursor:pointer}
    .btn{background:linear-gradient(180deg,var(--accent),var(--accent2));border:1px solid rgba(0,0,0,.25)}
    .btn:hover{filter:brightness(1.08)}
    .btn-ghost{background:#0b1220;border:1px solid rgba(148,163,184,.4)}
    .status{font-size:13px;color:var(--muted);margin-top:8px;min-height:18px}
    .err{color:#fca5a5}

    /* Modell-Auswahl: nur Name + Beschreibung */
    .models{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:12px;width:90%;max-width:1100px;margin:10px 0}
    .card{border:1px solid var(--border);background:var(--panel);border-radius:12px;padding:12px;cursor:pointer;transition:transform .05s ease}
    .card:hover{transform:translateY(-1px)}
    .card.active{outline:2px solid var(--accent)}
    .name{font-weight:bold;margin-bottom:6px}
    .desc{font-size:12px;color:#cbd5e1;opacity:.95;line-height:1.35}

    .assets{width:90%;max-width:900px;color:var(--muted);font-size:13px}
    .assets ul{margin:6px 0 0 16px;padding:0}
    .assets li{margin:2px 0}

    iframe#frame{
      width:90%;
      max-width:1100px;
      height:70vh;
      margin-top:12px;
      border:1px solid rgba(148,163,184,.25);
      border-radius:12px;
      background:var(--panel);
    }
  </style>
  <link rel="icon" href="/static/logo.jpg">
</head>
<body>
  <img src="/static/logo.jpg" alt="Logo" style="width:120px;border-radius:12px;margin-bottom:10px" onerror="this.style.display='none'">
  <h1>üß† Website-Generator KI</h1>

  <p class="hint">Beschreibe deine Website:</p>
  <textarea id="prompt" placeholder="z. B. One-Pager mit Hero, Leistungen, Galerie (nutze hochgeladene Bilder), Kontakt."></textarea>

  <div class="models" id="models"></div>

  <div class="row">
    <button id="btnGen" class="btn">Website erstellen</button>
    <button id="btnSave" class="btn-ghost">Als HTML speichern</button>
    <button id="btnBundle" class="btn-ghost" disabled>Bundle herunterladen</button>
  </div>

  <div class="row">
    <input id="fileInput" type="file" multiple accept="image/*" />
    <button id="btnUpload" class="btn">Bilder hochladen</button>
  </div>

  <div class="assets" id="assetsBox" style="display:none">
    <strong>Hochgeladene Bilder:</strong>
    <ul id="assetsList"></ul>
  </div>

  <div class="status" id="status"></div>

  <iframe id="frame" sandbox="allow-same-origin allow-scripts"></iframe>

  <script>
    const $ = s => document.querySelector(s);
    const statusEl = $("#status");
    const modelsEl = $("#models");
    const btnBundle = $("#btnBundle");
    const assetsBox = $("#assetsBox");
    const assetsList = $("#assetsList");
    const frame = $("#frame");

    let currentBundleId = null;
    let currentAssets = [];
    let selectedModel = "qwen3-coder:480b-cloud";

    // Nur Name + Kurzbeschreibung (aus deiner Tabelle)
    const PRESETS = {
      "deepseek-v3.1:671b-cloud": {label:"DeepSeek V3.1", desc:"st√§rkstes Gesamtmodell (Reasoning + Coding + Analyse)"},
      "qwen3-coder:480b-cloud":   {label:"Qwen3 Coder",   desc:"beste Codeleistung, stark auch sprachlich"},
      "glm-4.6:cloud":            {label:"GLM-4.6",       desc:"gutes Gleichgewicht aus Leistung und Tempo"},
      "gpt-oss:120b-cloud":       {label:"GPT-OSS 120B",  desc:"solider Allrounder"},
      "qwen3-vl:235b-cloud":      {label:"Qwen3-VL",      desc:"stark f√ºr Text+Bild"},
      "minimax-m2:cloud":         {label:"MiniMax-M2",    desc:"leichtgewichtig, schnell"},
      "gpt-oss:20b-cloud":        {label:"GPT-OSS 20B",   desc:"kleine Aufgaben"}
    };

    function setStatus(m, err=false){ statusEl.textContent=m||""; statusEl.className="status"+(err?" err":""); }

    function renderModelCards(){
      modelsEl.innerHTML = "";
      Object.entries(PRESETS).forEach(([key, p])=>{
        const card = document.createElement("div");
        card.className = "card" + (key===selectedModel ? " active":"");
        card.innerHTML = `
          <div class="name">${p.label}</div>
          <div class="desc">${p.desc}</div>
        `;
        card.addEventListener("click", ()=>{
          document.querySelectorAll(".card").forEach(c=>c.classList.remove("active"));
          card.classList.add("active");
          selectedModel = key;
          setStatus("Modell: " + p.label);
        });
        modelsEl.appendChild(card);
      });
    }
    renderModelCards();

    async function uploadFiles(){
      const inp = document.getElementById("fileInput");
      if(!inp.files.length){ setStatus("Bitte Bilder ausw√§hlen.", true); return; }
      const fd = new FormData();
      for(const f of inp.files){ fd.append("files", f, f.name); }
      if(currentBundleId){ fd.append("bundle_id", currentBundleId); }
      setStatus("Lade Bilder hoch ‚Ä¶");
      try{
        const res = await fetch("/upload", { method:"POST", body: fd });
        const data = await res.json();
        if(!res.ok){ throw new Error(data?.detail || res.statusText); }
        currentBundleId = data.bundle_id;
        currentAssets = data.assets || [];
        renderAssets();
        btnBundle.disabled = !currentBundleId;
        setStatus(`Hochgeladen: ${currentAssets.length} Datei(en).`);
      }catch(e){
        setStatus("Upload-Fehler: "+e.message, true);
      }
    }

    function renderAssets(){
      assetsList.innerHTML = "";
      for(const n of currentAssets){
        const li = document.createElement("li");
        li.textContent = n;
        assetsList.appendChild(li);
      }
      assetsBox.style.display = currentAssets.length ? "block" : "none";
    }

    function renderInIframe(html){
      const doc = frame.contentDocument || frame.contentWindow.document;
      doc.open(); doc.write(html); doc.close();
    }

    async function generate(){
      const prompt = document.getElementById("prompt").value.trim();
      if(!prompt){ setStatus("Bitte eine Beschreibung eingeben.", true); return; }
      setStatus("Erzeuge HTML ‚Ä¶");
      frame.srcdoc = "<div style='font-family:sans-serif;color:#e5e7eb;background:#0f172a;padding:20px'>‚è≥ Die KI erstellt deine Website ‚Ä¶</div>";
      try{
        const res = await fetch("/generate", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({
            prompt,
            model: selectedModel,
            // Serverseite steuert Tokenbudget; UI zeigt nichts davon
            bundle_id: currentBundleId,
            image_names: currentAssets.length ? currentAssets : undefined
          })
        });
        const raw = await res.text();
        if(!res.ok){ throw new Error(`HTTP ${res.status} ‚Äì ${raw.slice(0,300)}`); }
        const data = JSON.parse(raw);
        currentBundleId = data.bundle_id;
        btnBundle.disabled = !currentBundleId;

        const html = data?.html_preview || data?.html || "";
        if(!html) throw new Error("Leere Antwort vom Backend.");
        renderInIframe(html);
        setStatus("Fertig. Vorschau im iFrame geladen.");
      }catch(e){
        setStatus("Fehler: "+e.message, true);
        frame.srcdoc = "<div style='font-family:sans-serif;color:#fca5a5;padding:20px'>üö´ Fehler beim Generieren.</div>";
        console.error(e);
      }
    }

    function saveAsHtml(){
      const doc = frame.contentDocument || frame.contentWindow.document;
      const html = doc?.documentElement?.outerHTML || "";
      if(!html){ setStatus("Nichts zum Speichern.", true); return; }
      const blob = new Blob([html], {type:"text/html;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "website.html";
      document.body.appendChild(a);
      a.click(); a.remove();
      URL.revokeObjectURL(a.href);
      setStatus("HTML gespeichert.");
    }

    function downloadBundle(){
      if(!currentBundleId){ setStatus("Kein Bundle vorhanden.", true); return; }
      const a = document.createElement("a");
      a.href = `/bundle/${currentBundleId}.zip`;
      a.download = `${currentBundleId}.zip`;
      document.body.appendChild(a);
      a.click(); a.remove();
      setStatus("Bundle wird heruntergeladen.");
    }

    $("#btnUpload").addEventListener("click", uploadFiles);
    $("#btnGen").addEventListener("click", generate);
    $("#btnSave").addEventListener("click", saveAsHtml);
    $("#btnBundle").addEventListener("click", downloadBundle);
  </script>
</body>
</html>
